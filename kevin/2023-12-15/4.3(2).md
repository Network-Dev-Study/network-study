# 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등(2)

## 네트워크 주소 변환(NAT)

모든 IP활용 장치에는 IP주소가 필요하다.

SOHO(Small Office, Home Office) 네트워크의 확산으로 인해, SOHO가 장치를 연결하기 위해 LAN을 설치할 때 마다 ISP는 모든 SOHO의 IP장치를 수용할 수 있는 주소범위를 할당해야한다.

이미 ISP가 해당 주소 범위의 일정 부분을 할당해도 NAT를 통해 주소를 할당할 수 있다.

![Untitled](https://user-images.githubusercontent.com/76640167/212688870-ba4c2f2c-522f-438d-9eb3-3a518e76a7a9.png)

홈 네트워크 4개의 인터페이스 모두 같은 네트워크 주소 10.0.0.0/24를 가지고

주소 공간 10.0.0.0/8은 사설망 또는 홈 네트워크와 같은 **사설 개인 주소를 갖는 권역(realm)**을 위해 예약된 IP주소 공간 세 부분 중의 하나다.

여기서 사설주소를 권역이란 네트워크 주소들이 그 네트워크의 내부에 있는 장비에게만 의미있는 그런 네트워크를 의미한다.

만약 홈 네트워크의 정보들을 글로벌 인터넷으로 보낼려 한다면 홈 네트워크 안의 주소로는 송신할 수 없다.

이 문제를 해결하기 위해 NAT를 사용한다.

NAT 라우터는 외부 입장에서 라우터로 보이지 않고 하나의 장비처럼 보이지만, 위의 IP 138.76.29.7을 가진 라우터가 송신하는 데이터그램에 출발지 주소를 자신의 주소로 바꾸며

수신하는 데이터그램에 목적지 주소를 해당 장치의 주소로 바꾸는 모습을 볼 수 있다.

라우터가 한 IP주소를 얻는 방법은 DHCP를 사용하여 정확한 IP를 제공받는다.

WAN에서 NAT라우터로 모든 데이터그램이 도착하면 라우터가 주어진 데이터그램을 전달하는 방법으로

NAT 변환 테이블을 사용해 그 테이블의 IP주소와 포트 번호를 포함한다.

포트 번호는 호스트 주소 지정이 아닌 프로세스 주소 지정에 사용된다.

서버 프로세스는 잘 알려진 포트 번호에서 요청이 올 때까지 기다리고 P2P 프로토콜의 피어는 서버로서의 역할을 할 때 들어오는 연결을 수락해야 하기 때문에 홈 네트워크에서 실행되는 서버에 문제가 발생할 수 있다.

이 문제의 기술적인 해결책으로는 NAT 순회 도구가 있다.

## IPv6

IPv4의 주소 공간이 빠른 속도로 고갈되고 있음을 깨닫고 IPv6을 1990년 중반 개발하기 시작했다.

(참고로 IPv5는 구상만 하다가 나중에 삭제되었다.)

### IPv6 데이터그램 포맷

![Untitled](https://user-images.githubusercontent.com/76640167/212698226-9bf18f85-3111-4434-9202-f2ed45aabd28.png)

IPv4와 다른점은 다음과 같다.

- 확장된 주소 기능
  IP주소 32비트 → 128비트로 확장
  유니캐스트, 멀티캐스트 주소뿐만 아니라 새로운 주소 형태인 **애니캐스트** 주소가 도입되었다.
  이 주소로 명시된 데이터그램은 호스트 그룹의 어떤 이에에든 전달할 수 있다.
- 간소화된 40바이트 헤더
  IPv4의 많은 필드가 생략되어나 옵션으로 남겨졌다.
- 흐름 레이블링
  IPv6은 정의하기 어려운 흐름을 갖고 있다.
  문서에는 “비 디폴트 품질 서비스나 실시간 서버스 같은 특별한 처리를 요청하는 송신자에 대해 특정 흐름에 속하는 패킷 레이블링”을 가능하게 한다고 설명한다.
  높은 사용자 우선순위를 가지고 전달된 트래픽이나 오디오/비디오 전송은 흐름으로 처리될 수 있다.

다음은 IPv6에 정의된 필드들이다.

- 버전

  4비트 필드는 IP버전 번호를 인식한다.

  IPv6의 이 필드 값은 6이다. 그러나 IPv4의 필드 값은 4로 설정한다 해도 IPv4 데이터그램을 만드는 것이 아니다.

- 트래픽 클래스
  IPv4의 TOS 필드와 비슷한 의미로 만든 8비트 필드는 흐름 내의 SMTP 이메일 같은 애플리케이션의 데이터그램 보다 VoIP 같은 특정 애플리케이션 데이터그램에 우선 순위를 부여하는 데 사용된다.
- 흐름 레이블
  20비트 필드로, 위의 언급된 내용과 같다.
- 페이로드 길이
  16비트로 되어 있고 IPv6데이터그램에서 고정 길이 40바이트 패킷 헤더 뒤에 나오는 바이트 길이이며, 부호 없는 정수(unsigned integer)다.
- 다음 헤더
  데이터그램의 내용이 전달될 프로토콜을 구분한다.
  IPv4에 있는 프로토콜 필드와 같다.
- 홉 제한
  라우터가 데이터그램을 전달할 때 마다 1씩 감소한다.
  값이 0보다 작아지면 이 데이터그램은 버려진다.
- 출발지와 목적지 주소

- 데이터
  데이터그램의 페이로드 부분이다.
  데이터그램이 목적지에 도착하면페이로드를 저가한 후, 다음 헤더필드에 명시한 프로토콜에 전달한다.

다음은 IPv6으로 가면서 없어진 기능들이다.

- 단편화/재결합
  IPv6에서는 출발지와 목적지만 단편화와 재결합을 수행한다.
  만약 라우터가 받은 데이터그램의 크기가 너무 커서 출력 링크로 전달하지 못한다면
  라우터는 데이터그램을 폐기하고 ‘패킷이 너무 크다’라는 ICMP 오류 메시지를 송신자에게 보낸다.
  단편화와 재결합 자체에 시간이 걸리므로 라우터에서 이 기능을 삭제하고 종단 시스템에서 하게 되면 IP 전달 속도가 증가한다.
- 헤더 체크섬
  트랜스포트와 링크 계층에서 체크섬을 수행하므로 IP설계자 입장에서 굳이 네트워크 계층에서 해도 되지 않으므로 생략한다.
  라우터 마다 체크섬을 하지 않아도 되므로 비용이 덜 들게 된다.
- 옵션
  옵션은 완전히 사라진 것은 아니지만 IPv6에서 ‘다음 헤더’ 중 하나가 될 수 있다.
  IP 헤더는 이제 고정된 40바이트 IP헤더를 갖게 된다.

### IPv4에서 IPv6으로 전환

이미 IPv4로 구축된 시스템은 IPv6 데이트그램을 처리할 수 없다.

이를 해결하기 위해 플래그 데이를 선언하는 방법이 있다.(거의 불가능하다.)

하는 방법은 모든 인터넷 장비를 끄고 IPv6으로 업그레이드하는 시간과 날짜를 정하는 것이다.

40년 전에 겨우하던 방법이라 지금은 불가능하다고 보면 된다.

요즘은 **터널링**이라는 방법을 통해 IPv6으로 전환한다.

![Untitled](https://user-images.githubusercontent.com/76640167/212711125-cbde816b-a934-4a2e-a404-92665e9e93ea.png)

터널링 방법에는

1. IPv6으로 데이터그램을 받고 만약 앞 라우터에 IPv4만 처리하는 라우터가 있다면 IPv4 데이터그램을 만들어서 안에 IPv6 데이터그램을 넣는다.
2. IPv4를 처리하는 라우터는 IPv4에 IPv6데이터그램이 있는 줄도 모르고 처리한다.
3. IPv6을 처리하는 라우터에 도착하면 IPv4 안에 IPv6이 있는 지 확인하고 IPv6이 있다면 다음 노드에 보낸다.

IPv6을 도입하는데 큰 비용이 들다 보니 아직 크게 상용화되어있진 않다.
