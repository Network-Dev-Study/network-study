# 웹 캐싱

## 웹 캐시(프록시 서버)란?

> 기점 웹 서버를 대신하여 HTTP 요구를 충족 시키는 네트워크 개체다.

## 특징

- 웹 캐시 자체의 저장 디스크를 가지고 있어 최근 호출된 객체의 사본을 저장 및 보존한다.

![Untitled](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT5Fd9aFT2W3VyAmcQpH0ojtNzC9z0NiIt6pQ&usqp=CAU)

- 예를 들어, www.naver.com/fda.gif라는 객체를 요구한다면

  1. 브라우저는 웹 캐시와 TCP연결을 설정하고 웹 캐시에 있는 객체에 대한 HTTP요청을 보낸다.
  2. 웹 캐시는 객체의 사본이 자기에게 저장되어 있는지 확인한다. 만약 저장되어 있다면 웹 캐시는 클라이언트 브라우저로 HTTP응답 메시지와 함께 객체를 전송한다.
  3. 만약 웹 캐시가 객체를 갖고 있지 않다면, 웹 캐시는 기점 서버인 www.naver.com으로 TCP연결을 설정한다.

     3-1. 웹 캐시는 캐시와 서버 간의 TCP연결로 객체에 대한 HTTP요청을 보낸다.

     3-2. 기점 서버는 웹 캐시로 HTTP응답 메시지와 함께 객체를보낸다.

  4. 웹 캐시의 객체를 수신할 때, 객체를 지역 저장장치에 복사하고 클라이언트 브라우저에 HTTP응답 메시지와 함께 객체의 사본을 클라이언트와 캐시 사이에 연결된 TCP로 보낸다.

- 여기서 캐시는 서버이면서 클라이언트라는 점을 유의해야 한다.(브라우저의 입장에서 캐시는 서버고, 기점 서버의 입장에서 캐시는 클라이언트다.)
- 일반적으로 웹 캐시는 ISP(Internet Service Provider: 인터넷 제공자)가 구입하고 설치한다.

## 장점

1. 웹 캐시는 클라이언트의 요구에 대한 응답 시간을 줄일 수 있다.(클라이언트와 기점 서버 사이의 병목 대역폭이 클라이언트와 캐시 사이의 병목 대역폭에 비해 매우 작을 때 더욱 효과적이다.)
2. 한 기관에서 인터넷으로 접속하는 링크상의 웹 트래픽을 대폭으로 줄일 수 있다.
3. 인터넷 전체의 웹 트래픽을 실질적으로 줄여줘서 모든 애플리케이션의 성능을 개선한다.

## 장점(자세히)

![Untitled](https://user-images.githubusercontent.com/76640167/210504713-f02f053c-e503-413f-8cbc-046c55082359.png)

웹 캐시가 없는 경우, 브라우저의 요청 부터 객체 수신까지 걸리는 시간은

> (LAN지연 시간)+(접속 지연 시간)+(인터넷 지연 시간) = (총 걸리는 시간)

위의 사진과 같은 조건에서 브라우저가 요청하는 객체의 크기는 평균 1Mb,

브라우저에서 기관 서버까지 평균 요청 비율이 15요청이라 가정한다면

LAN의 트래픽 강도는

`(15요청/초) * (1 Mb/요청) / (100Mbps) = 0.15`

접속 회전(인터넷 라우터에서 기관 라우터 사이)의 트래픽 강도는

`(15요청/초) * (1 Mb/요청) / (15Mbps) = 1`

일반적으로 LAN의 트래픽 강도가 0.15면 몇십ms(LAN지연 시간)의 지연을 야기하기 때문에 별차이 없지만, 트래픽 강도가 1에 가까워지면 접속 회선의 경우 회선의 지연이 매우 커지고 증가한다.(처리하는 속도가 평균 요청되어 들어오는 속도와 같기 때문에 순간 접속회선에서 지연이 발생할 수 있다.)

결론적으로 접속 지연시간에 대략 몇분 이상 걸릴 것이다.

이를 해결하기 위한 방법으로는

1. 접속 회선의 접속률을 100Mbps만큼 늘려서 전송 지연을 무시할 수 있는 수준인 0.15까지 낮춰서 인터넷 지연 시간인 2초만 남는 방법이 있지만, 많은 비용이 들어간다.
2. 접속 회선을 증설하지 않고 기관 네트워크에 웹 캐시를 설치하는 벙법이 있다.

![Untitled](https://user-images.githubusercontent.com/76640167/210506730-5cb70fea-a9ed-4817-afe0-4463bfd24a4a.png)

2번 방법에서, 적중률(웹 캐시가 브라우저에게 바로 객체를 전달해줄 확률)은 일반적으로 0.2~0.7이지만, 0.4라고 가정한다.

그렇게 된다면 캐시는 클라이언트과 고속 LAN으로 연결되어 있어서 40%는즉시(10ms이내) 만족되고 60%의 기존 접속 회선을 사용하는 요청의 경우 트래픽 강도는 1에서 0.6으로 감소된다.

트래픽 강도가 0.8미만인 경우, 수십ms정도의 작은 지연이 발생하고 추가로 인터넷 지연시간인 2초가 걸리므로 계산하면

`0.4*0.01 + 0.6*(2.01) = (약 1.2초)`

첫번째 방법인 2초 보다 짧고 훨씬 저렴한 가격으로 접속 지연 문제를 해결할 수 있다.

기관에서 캐시를 구입하기 위해 저렴한 PC에서 공유CDN(Content Distrubution Network) 혹은 지역CDN을 사용하여 많은 트래픽을 지역화하고 있다.

## 조건부 GET

웹 캐싱을 사용하다 보면 클라이언트 입장에서 과연 이 복사본이 새것이 아닐까하는 의심을 하게 된다.(복사본이 클라이언트에 캐싱된 이후에 웹 서버에 있는 객체가 갱신되었을 수 있다.)

다행히도, HTTP는 클라이언트가 브라우저로 전달되는 모든 객체가 최신의 것임을 확인하면서 캐싱을 하게 해주는 방식을 가지고 있다.

이를 **조건부 GET**이라 한다.

HTTP요청 메시지에서

1. `GET`방식을 사용하고
2. `If-Modified-Since:` 헤더 라인을 포함하고 있다면

그것이 조건부 GET 메시지다

조건부 GET이 작동하는 방식을 예시로 보자면,

1. 캐시는 요청 메시지를 웹 서버로 보낸다.
2. 웹 서버를 캐시에게 객체를 가진 응답 메시지를 보낸다.(응답 메시지 안에 마지막으로 수정된 시간과 날짜가 적혀 있다.)
3. 일주일 후, 다른 브라우저가 같은 객체를 캐시에게 요청하면 객체는 여진히 저장되어 있다. 이 객체는 지난주에 웹 서버에서 수정되었으므로 브라우저는 웹 서버에게 `If-Modified-Since:` 가 포함되어 있는 HTTP요청 메시지를 보낸다.
4. 서버는 브라우저가 보낸 `If-Modified-Since:` 를 보고 마지막으로 수정한 날짜가 같다면 응답 메시지에 `304 Not Modified`상태 라인과 요청 메시지에 포함한 객체를 포함하지 않고 브라우저에게 전달한다.(이는 요청 객체의 캐싱된 복사본을 사용하라는 것을 의미한다.)
