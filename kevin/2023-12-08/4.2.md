# 라우터 내부

상위 레벨에서 본 관점에서 일반적인 라우터 구조는 아래 그림이라 볼 수 있으며, 네가지 요소를 정의한다.

![Untitled](https://user-images.githubusercontent.com/76640167/212551546-16b6533b-58ec-421a-9863-e7d581e0cb41.png)

1. 입력 포트

   입력 포트의 맨 왼쪽 박스와 출력 포트의 맨 오른쪽 박스는 라우터로 들어오는 입력 링크로, 물리 계층 기능을 수행한다.(작은 박스)

   그리고 입력 포트는 들어오는 링크의 반대편에 있는 링크계층과 상호 운용하기 위해 필요한 링크 계층 기능을 수행한다.(중간 박스)

   입력 포트의 가장 오른쪽 박스에서 검색 기능을 수행하여 포워딩 테이블을 참조해 스위치 구조로 라우터 출력 포트를 결정한다.

   여기서 ‘포트’는 물리적인 입출력 라우터 인터페이스를 의미한다.

2. 스위치 구조

   라우터의 입력 포트와 출력 포트를 연결한다. 그리고 라우터 내부에 포함되어 있다.

3. 출력 포트

   스위치 구조에서 수신한 패킷을 저장하고 필요한 링크 계층 및 물리 계층 기능을 수행하여 출력 링크로 패킷을 전송한다.

   트래픽을 전달하는 링크가 양방향인 경우, 출력 포트는 일반적으로 동일한 링크의 입력 포트와 한 쌍을 이룬다.

4. 라우팅 프로세서

   제어 평면 기능을 수행한다.

   기존의 라우터에서는 라우팅 프로토콜을 실행하여 라우팅 테이블과 연결된 링크 상태 정보를 유지 관리하며 라우터의 포워딩 테이블을 계산한다.

   SDN 라우터에서는 원격 컨트롤러와 통신하여 계산된 포워딩 테이블 엔드리를 수신하고 라우터의 입력 포트에 이러한 엔트리를 설치한다.

라우터의 입력 포트, 출력 포트, 스위치 구조는 거의 항상 하드웨어로 구현된다.

제어 평면은 일반적으로 소프트웨어로 구현되며 라우팅 프로세서(일반적으로 기존 CPU)에서 실행된다.

## 입력 포트 처리 및 목적지 기반 전송

![Untitled](https://user-images.githubusercontent.com/76640167/212552679-134bbf97-c8fd-452c-a6dc-283454e8d745.png)

입력 포트의 라인 종단(Line termination) 기능과 링크 계층 처리는 라우터의 개별 입력 링크와 관련된 물리 계층 및 데이터 링크 계층을 구현한다.

입력 포트에서 수행되는 검색은 라우터 동작의 핵심이다.

라우터는 포워딩 테이블을 사용하여 도착 패킷이 스위치 구조를 통해 전달되는 출력 포트를 검색한다.

포워딩 테이블은 라우팅 프로세서에서 계산되거나 갱신되거나 원격 SDN 컨트롤러에서 수신된다.

포워딩 테이블은 라우팅 프로세서에서 맨위 그림과 같이 각 라인 카드로 복사되고, 이렇게 각 라인이 복사본을 사용하여 패킷 단위로 중앙 집중식 라우팅 프로세서를 호출하지 않게 되어 병목 현상을 피할 수 있다.

입력 패킷을 스위칭할 출력 포트가 각 패킷의 목적지 주소를 기반으로 하는 가장 간단한 경우,

포워딩 테이블을 억지로 구현한다면 가능한 목적지 주소마다 하나의 엔트리가 필요하므로 매우 많은 개수의 엔트리가 필요하다.

그렇다면 어떻게 해결해야 할까?

![Untitled](https://user-images.githubusercontent.com/76640167/212553661-aa22e2b5-353c-4cba-95e6-66ae79c2968e.png)

위 사진 처럼 범위를 정하고 인터페이스를 지정하면 된다.

![Untitled](https://user-images.githubusercontent.com/76640167/212553874-8c0c057e-f9a2-4533-bf21-c2196fa6e4fc.png)

라우터는 패킷의 목적지 주소의 프리픽스를 테이블의 엔트리와 매치하고

매치되는 엔트리가 존재하면 라우터는 패킷을 그 매치에 연관된 링크로 보낸다.

하지만 여기 중요한 세부 요소가 있는데,

위의 프리 픽스를 보면 알 수 있듯이 패킷의 목적지 주소가 매치 되는 주소들이 있다.

이렇게 다수의 매치가 있을 경우, 프리픽스 매치 규칙을 사용하여 가장 긴 매치 엔트리를 찾아 연관된 링크 인터페이스로 패킷을 보낸다.

(최장 프리픽스 매치는 4.3절에서..)

포워딩 테이블을 통한 검색에서는 빠르게 수행하기 위해 선형 검색 이외의 기술이 필요하다.

검색을 통해 패킷의 출력 포트가 결정되면 패킷을 스위치 구조로 보낼 수 있다.

일부 설계에서는 다른 입력 포트로부터 패킷이 현재 스위치 구조를 사용하고 있다면 패킷이 스위칭 구조에 들어가는 것을 일시적으로 차단할 수 있다.
