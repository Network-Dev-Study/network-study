# 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등(1)

## IPv4 데이터그램 포맷

![Untitled](https://user-images.githubusercontent.com/76640167/212647972-acc5a773-a64c-4cd9-adb8-13f3f02876b9.png)

여기서 주요 필드를 살펴보면

- 버전 번호
  4비트로 데이터그램의 IP프로토콜 버전을 명시한다.
  라우터는 버전 번호를 확인하여 데이터그램의 나머지 부분을 어떻게 해석할지 결정한다.
- 헤더 길이
  헤더에 가변 길이의 옵션을 포함하므로 이 네 비트로 IP 데이터그램에서 실제 페이로드가 시작하는 곳을 결정한다.
  대부분의 IPv4 데이터그램은 옵션을 포함하지 않으므로 20바이트정도 된다.
- 서비스 타입
  서비스 타입(type of service, TOS) 비트는 각기 다른 유형의 IP데이터그램을 구별한다.
  TOS 비트 중 2비트는 명시적 혼잡 알림에 사용된다.
- 데이터그램 길이
  바이트로 계산한 데이터그램의 전체 길이이다.
  이 필드의 크기는 16비트이지만 데이터그램은 보통 1500바이트 보다 큰 경우는 없으므로 최대 크기의 이더넷 프레임의 페이로드 필드에 IP데이터그램이 장착될 수 있다.
- 식별자, 플래그, 단편화 오프셋
  IP단편화와 관련있는데, 큰 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할된 다음 목적지로 독립적으로 전달된다.
  여기서 페이로드 데이터가 최종 호스트의 트랜스포트 계층으로 전달되기 전에 다시 모이게 된다.
  IPv6에서는 사용하지 않고, 책에서도 다루지 않는다.
- TTL(time-to-live)
  네트워크에서 데이터그램이 무한히 순환하지 않도록 한다(라우팅 루프).
  이 필드값은 라우터가 데이터그램을 처리할 때마다 감소한다.
  값이 0이 되면 데이터그램을 폐기한다.
- 프로토콜
  일반적으로 IP데이터그램이 최종 목적지에 도착했을 때만 사용된다.
  필드 값은 IP 데이터그램에서 데이터 부분이 전달될 목적지의 트랜스포트 계층의 특정 프로토콜을 명시한다.
  트랜스포트 계층의 포트 번호 필드의 역할과 유사하다.
- 헤더 체크섬
  라우터가 수신한 IP 데이터그램의 비트 오류를 탐지하는데 도움을 준다.
  예전에 봤던 1의 보수를 체크섬 필드에 저장하여 라우터에서 체그섬 계산 후 틀린 값이면 데이터그램을 폐기하는 방식으로 진행한다.
  TCP/IP는 왜 계속 오류검사를 할까?
  - IP 헤더만 IP 계층에서 체크섬을 수행하지만 TCP/UDP 체크섬은 전체 TCP/UDP 세그먼트를 계산한다.
  - TCP/UDP와 IP는 동일한 프로토콜 스택에 속할 필요가 없다. 원리상 TCP는 IP가 아닌 곳 위에서도 운영될 수 있다.
- 출발지와 목적지 IP주소

  출발지 IP주소를 넣은 후, DNS검색을 통해 나온 목적지 주소를 목적지 IP주소에 넣는다.

  (4.3.2에서..)

- 옵션
  IP 헤더를 확장한다.
  모든 데이터그램 헤더 옵션 필드에 정보를 포함하지 않는 방법으로 오버헤드를 해결하기 위해 헤더 옵션은 거의 사용되지 않는다.
  매우 복잡한 문제가 생기므로 IPv6에서는 포함되지 않는다.
- 데이터(페이로드)
  데이터그램이 존재하는 이유 + 가장 중요한 마지막 필드다.
  대부분 세그먼트를 포함하지만, ICMP 메시지같은 유형의 데이터를 담기도 한다.

IP 데이터그램은 총 20바이트의 헤더를 갖고 TCP 세그먼트를 전송한다면

각 데이터그램은 애플리케이션 계층의 메시지를 포함해 총 40바이트의 헤더를 전송한다.

## IPv4 주소체계

호스트는 일반적으로 네트워크와 연결되는 하나의 링크를 갖는다.

호스트 IP가 데이터그램을 보낼때 이 링크를 통해 데이터링크를 보낸다.

인터페이스: 호스트와 물리적 링크 사이의 경계

라우터는 2개 이상의 연결된 링크가 필요하다(내보내고, 받으므로)

라우터는 여러 개의 인터페이스를 갖고 모든 호스트와 라우터는 IP데이터그램을 송수신할 수 있으므로 IP는 각 호스트와 라우터 인터페이스가 IP주소를 갖도록 요구한다.

따라서 IP주소는 기술면에서 라우터보다 인터페이스와 관련이 있다.

각 IP주소는 32비트 길이로, 약 40억개의 주소를 사용할 수 있다.

이 주소는 일반적으로 각 바이트를 십진수로 표현하고 주소의 다른 바이트와 점으로 구분하는 십진표기법을 사용한다.

전 세계 인터넷에서 모든 호스트와 라우터의 각 인터페이스는 고유한 IP주소를 갖고 이런 주소는 마음대로 선택할 수 없다.

인터페이스의 IP주소 일부는 연결된 ‘서브넷’이 결정한다.

![Untitled](https://user-images.githubusercontent.com/76640167/212662555-482eb213-def6-4066-b4ca-2b7e65714196.png)

위 그림은 IP 주소체계와 인터페이스의 예를 보여준다.

각각의 호스트들은 연결된 라우터의 IP주소의 동일한 왼쪽 24비트를 사용한다.

그리고 4개의 인터페이스가 중계하는 라우터 없이 하나의 네트워크에 서로 연결되어 있다.

이 네트워크는 이더넷 LAN으로 상호연결되고 이 경우 인터페이스는 이더넷 허브나 이더넷 스위치 또는 무선 AP로 상호연결된다.

(이 네트워크는 6장과 7장에서..)

IP용어로 세 호스트들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크는 서브넷을 구성한다고 말한다.

IP 주소체계는 이 서브넷에 `223.1.1.0/24` 라는 세 호스트 인터페이스와 하나의 라우터 인터페이스를 구성한다.

위 그림에 2개의 서브넷(1.3, 1.2)이 있다.

![Untitled](https://user-images.githubusercontent.com/76640167/212667479-eb056442-26a3-4e8f-8bf7-97a1e864981a.png)

서브넷의 IP 정의는 여러 호스트를 라우터 인터페이스에 연결하는 이더넷 세그먼트만을 의미하는 것은 아니다.

위 그림에서 라우터와 라우터를 연결하는 인터페이스용으로 서브넷들이 추가되었다.

라우터와 호스트를 연결한 시스템의 서브넷을 정의하자면 다음과 같다.

서브넷을 결정하려면 먼저 호스트나 라우터에서 각 인터페이스를 분리하고 고립된 네트워크를 만든다. 이 고립된 네트워크의 종단점은 인터페이스의 끝이 된다. 이렇게 고립된 네트워크 각각을 서브넷이라고 부른다.

위에 의하면 다수의 이더넷 세그먼트와 종단 간의 링크를 갖는 기관은 한 서브넷에서 모든 장비가 같은 서브넷 주소를 갖는 그런 서브넷을 여러개 가질 수 있다.

서로 다른 서브넷은 다른 주소를 가져야 하지만 실제로 서브넷 주소는 같은 부분이 많다.

인터넷 주소 할당 방식에 CIDR(Classless InterDomain Routing, 사이다)라는 것이 있다.

CIDR은 서브넷 주소체계 표기를 일반화하고 있다.

서브넷 주소체계로서, 32비트 IP주소는 두 부분으로 나누고, 이것은 다시 점으로 된 십진수 형태의 a.b.c.d/x를 가지며, 여기서 x는 주소의 첫 부분의 비트 수다.

a.b.c.d/x 형식 주소에서 최상위 비트(MSB)를 의미하는 x는 IP주소의 네트워크 부분을 구성한다.

이를 해당 주소의 프리픽스 또는 네트워크 프리픽스라 부른다.

한 기관에서 통상 연속적인 주소의 블록을 할당받으면서 기관 장비의 IP주소들은 공통 프리픽스를 공유한다.

그래서 외부기관의 라우터들은 목적지 주소가 내부 기관인 데이터그램을 전송할 때, 앞의 x비트들만 고려한다.

이런 방식은 포워딩 테이블의 크기를 상당히 줄여준다.

x비트를 제외한 나머지 비트들은 기관 내부에 같은 네트워크 프리픽스를 갖는 모든 장비를 구별한다.

이 하위 비트들은 추가 서브넷 구조를 가질 수 있기 때문에 해당 비트들로 기관 내 장비에 도달한다.

CIDR 이전에 IP 주소의 네트워크 부분을 8, 16, 24비트로 제한하여 해당 서브넷 주소를 갖는 서브넷을 각각 A, B, C클래스 네트워크로 분류했기 때문에

이런 주소체계를 클래스 주소체계라고 알려졌다.

그러나 서브넷 부분이 정확히 1, 2, 3 바이트여야 하는 요구사항은 중소형 크기의 네트워크로 급속히 증가하는 기관의 수를 지원하기엔 문제가 있었다.

예를 들어 클래스(/24) 서브넷은 254개의 호스트만을 제공하므로 많은 조직을 위해서는 턱없이 부족하고, 클래스(/16) 서브넷은 65634개의 호스트를 제공하여 너무 크다.

IP 주소의 또 다른 형태인 브로드캐스트 주소(255.255.255.255)가 있다.

호스트가 목적지 주소가 위 주소인 해당 데이터그램을 보내면 이 메시지는 서브넷에 있는 모든 호스트에게 전달된다.

마찬가지로 라우터도 이웃 서브넷에 메시지를 전달한다.

### 주소 블록 획득

기관이 서브넷에서 사용하기 위한 IP주소 블록을 얻기 위해, 네트워크 관리자는 먼저 이미 할당받은 주소의 큰 블록에서 주소를 제공하는 ISP와 접촉해야 한다.

![Untitled](https://user-images.githubusercontent.com/76640167/212675085-61430550-15e6-4fb9-a909-1a7bb8bac116.png)

ISP로 부터 주소를 획득하는 방법 말고 다른 방법으로 ISP와 다른 조직에 주소 블록을 할당하는 최상위 기관이 있다.

이런 IP주소는 ICANN을 기반으로 관리한다.

비영리 단체인 ICANN의 역할은 IP주소 할당과 DNS 루트서버 관리이다.

추가로 도메인 이름 할당과 도메인 이름 분쟁을 해결한다.

ICANN은 지역 인터넷 등록소에서 지역 내 주소의 할당/관리를 제어하게 한다.

### 호스트 주소 획득: 동적 호스트 구성 프로토콜

한 기관은 ISP로부터 주소 블록을 획득하여, 개별 IP 주소를 기관 내부의 호스트와 라우터 인터페이스에 할당한다.

라우터 인터페이스 주소에 대해, 시스템 관리자는 라우터 안에 IP 주소를 할당한다.

호스트에 IP 주소를 할당하는 것은 수동으로 구성이 가능하지만 일반적으로 `동적 호스트 구성 프로토콜(DHCP)`을 많이 사용한다.

DHCP는 호스트가 IP 주소를 자동으로 얻을 수 있게 하고, 서브넷 마스크, 첫 번째 홉 라우터 주소나 로컬 DNS 서버 주소 같은 추가 정보를 얻게 해준다.

DHCP는 자동으로 호스트와 연결해주는 능력 때문에 플러그 앤 플레이 프로토콜 또는 제로 구성 프로토콜이라고도 한다.

DHCP는 호스트가 빈번하게 접속하고 떠나는 가정 인터넷 접속 네트워크, 기업 네트워크, 무선 랜에서도 폭넓게 사용한다.

많은 사람들이 여기저기 와이파이에 접속할텐데, 이를 DHCP가 임시적으로 새로운 IP주소를 제공해준다.

DHCP는 클라이언트-서버 프로토콜이다.

일반적으로 IP주소를 포함하며 네트워크 설정을 위한 정보를 얻고자 새롭게 도착한 호스트다.

각 서브넷은 DHCP 서버를 갖거나 없다면 해당 네트워크에 대한 DHCP 서버 주소를 알려줄 DHCP 연결 에이전트(일반적으로 라우터)가 필요하다.

![Untitled](https://user-images.githubusercontent.com/76640167/212679674-19caa44a-265c-43c1-84a6-ecdcdbcaec8e.png)

![Untitled](https://user-images.githubusercontent.com/76640167/212680264-a3e3a046-d66c-46d3-b09f-2961a5717062.png)

여기서 새로운 호스트가 도착할 경우 DHCP 프로토콜 4단계의 과정을 보여준다.

위 그림에서 `yiaddrr` 은 새롭게 도착한 클라이언트에 할당될 주소를 나타낸다.

1. DHCP 서버 발견

   호스트는 상호작용할 DHCP를 발견한다.

   이 때 DHCP 발견 메시지를사용하여 수행되며 클라이언트는 67번 포트로 UDP패킷을 보낸다.

   클라이언트는 아무것도 모르므로 브로드캐스트 IP주소 `255.255.255.255` 로 설정하고 출발지는 `0.0.0.0` 으로 설정한다.

2. DHCP 서버 제공

   서버는 발견 메시지를 받고 DHCP 제공 메시지를 클라이언트로 응답한다.

   이 때도 서버는 `255.255.255.255`를 사용하여 메시지를 보낸다.

   클라이언트는 여러 DHCP서버의 출발지를 보고 최적의 위치에 있는 DHCP서버를 선택한다.

   서버 제공 메시지는 수신된 발견 메시지의 트랜젝션 ID, 클라이언트에 제공된 IP주소, 네트워크 마스크, IP주소 임대 기간을 포함한다.

   보통 임대 기간은 몇 시간 또는 며칠이다.

3. DHCP 요청

   클라이언트는 하나 또는 그 이상의 서버 중에서 선택하고 선택된 제공자에게 파라미터 설정으로 되돌아 오는 DHCP 요청 메시지로 응답할 것이다.

4. DHCP ACK

   서버는 DHCP 요청에 대해 요청된 파라미터를 확인하는 DHCP ACK 메시지로 응답한다.

클라이언트가 ACK를 받으면 상호작용은 종료되고 클라이언트는 할당받은 IP주소를 임대 기간동안 사용할 수 있다.

기간이 만료돼도 DHCP는 임대 기간을 갱신할 수 있는 메커니즘을 제공한다.

하지만 결점이 하나 있는데, 노드가 새로운 서브넷에 연결하고자 할 때

새로운 IP주소를 DHCP로 부터 얻기 때문에 이동 노드가 서브넷 사이를 이동할 때

원격 애플리케이션에 대한 TCP 연결은 유지될 수 없다.

(이에 대한 해결은 7장에서..)
